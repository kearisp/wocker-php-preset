#!/bin/sh

set -e

NAME="$1"

run_init_scripts() {
    set -e
    local scripts_dir="$1"

    if [ -d "$scripts_dir" ]; then
        echo "Running $NAME scripts from $scripts_dir"

        scripts=$(find "$scripts_dir" -type f -name "*.sh" | sort)
        for script in $scripts; do
            if [ -x "$script" ]; then
                echo "Executing $script"
                "$script" || {
                    status=$?
                    echo "Error: Script $script exited with non-zero $status status" >&2
                    exit $status
                }
            else
                echo "Executing $script with sh"
                sh "$script" || {
                    status=$?
                    echo "Error: Script $script exited with non-zero $status status" >&2
                    exit $status
                }
            fi
        done

        echo "Initialization scripts completed"
    else
        echo "No initialization scripts directory found at $scripts_dir"
    fi
}

case "$NAME" in
    "init")
        run_init_scripts "/etc/wocker/init.core.d"
        run_init_scripts "/etc/wocker/init.d"
        run_init_scripts "/etc/wocker-init.d"
        ;;
    "build")
        run_init_scripts "/etc/wocker/build.core.d"
        run_init_scripts "/etc/wocker/build.d"
        run_init_scripts "/etc/wocker-build.d"
        ;;
    *)
        echo "Error: Invalid name '$NAME'. Supported values are: init, build"
        exit 1
        ;;
esac
